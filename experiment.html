<!DOCTYPE html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css"
 href="https://fonts.googleapis.com/css?family=Roboto">
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
body {
}
#wrapper {
}
#experiment {
  height: 100%;
  width: 850px;
  margin: 20px auto;
}
.container {
  width: 425px;
  padding-right: 20px;
  display: inline-block;
  vertical-align: top;
  font-family: Roboto, sans-serif;
}
input {
  width: 250px;
  text-align: center;
  font-family: Roboto, sans-serif;
  font-size: 24px;
  color: #222;
  padding: 5px 10px;
  border: 2px solid #888;
  border-radius: 5px;
  outline: none;
  margin-bottom: 10px;
}
.cursor {
  color: #b5471c;
  font-weight: bold;
}
.labels, .tables {
  font-size: 24px;
  vertical-align: top;
  display: inline-block;
}
.labels {
  width: 250px;
  color: #666;
}
.tables {
  width: calc(100% - 250px);
}
.report {
  color: #222;
  padding-right: 5px;
  display: none;
}
.report.active {
  display: block
}
.label.active {
  background: #eee;
}
.label {
  cursor: default;
  display: inline-block;
  width: 250px;
  text-align: center;
  padding: 0 5px;
}
.report td {
  padding: 0 1px;
}
td.character, td.category {
  text-align: right;
  color: #000;
  padding: 0;
}
td.left {
  padding-left: 6px;
}
td.character span {
  display: inline-block;
  width: 24px;
  text-align: center;
  background: #ccc;
  border-radius: 2px;
  padding: 0 4px;
}
td.category {
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 2px;
  font-size: 14px;
  padding: 0 4px;
}
</style>
<script>

// Format a non-negative integer with no zero padding.
function format(s) {
  // Delete non-digits.
  s = s.replace(/\D/g, '');
  // Delete zero padding.
  s = s.replace(/^0+/, '0');
  if (s.charAt(0) == '0' && s.length > 1) {
    s = s.substring(1);
  }
  // Insert commas to separate groups of three digits.
  s = FormatNumber.groupDigits(s);
  return s;
}

function getCursorPosition(element) {
  return element.selectionStart;
}

function setCursorPosition(element, position) {
  element.setSelectionRange(position, position);
}

var original,
    formatted;

function getCounts(s) {
  var counts = {},
      i, ch;
  for (i = 0; i < s.length; ++i) {
    ch = s.charAt(i);
    if (ch in counts) {
      counts[ch] += 1;
    } else {
      counts[ch] = 1;
    }
  }
  return counts;
}

function getCommonCounts(a, b) {
  var aCounts = getCounts(a),
      bCounts = getCounts(b),
      counts = { a: {}, b: {} };
  Object.keys(aCounts).forEach(function (ch) {
    if (ch in bCounts) {
      counts.a[ch] = aCounts[ch];
      counts.b[ch] = bCounts[ch];
    }
  });
  return counts;
}

function newElement(tag, innerHTML, className) {
  var element = document.createElement(tag);
  if (innerHTML !== undefined && innerHTML !== null) {
    element.innerHTML = innerHTML;
  }
  if (className) {
    element.className = className;
  }
  return element;
}

function makeReport(tally, s, pos, aStats) {
  var stats, score, label, table,
      tbody, tr, td;
  // Stats.
  stats = { chars: {}, common: {}, distinct: {}, all: {} };
  Object.keys(tally.common.current).forEach(function (ch) {
    var count = tally.common.current[ch];
    stats.chars[ch] = { left: count };
    stats.chars[ch].right = tally.common.total[ch] - count;
  });
  stats.common.left = tally.common.sum.current;
  stats.common.right = tally.common.sum.total - stats.common.left;
  stats.distinct.left = tally.distinct.current;
  stats.distinct.right = tally.distinct.total - stats.distinct.left;
  stats.all.left = tally.all.current;
  stats.all.right = tally.all.total - stats.all.left;
  // Score.
  if (aStats) {
    score = 0;
    tally.common.characters.forEach(function (ch) {
      var aLeft = aStats.chars[ch].left,
          aRight = aStats.chars[ch].right,
          a = aLeft / (aLeft + aRight),
          bLeft = stats.chars[ch].left,
          bRight = stats.chars[ch].right,
          b = bLeft / (bLeft + bRight),
          diff = Math.abs(a - b),
          value = diff * diff;
      score += value;
    });
  }
  // Label.
  label = newElement('div', s.substring(0, pos) +
      '<span class="cursor">|</span>' + s.substring(pos), 'label');
  // Table.
  table = newElement('table');
  table.className = 'report';
  table.appendChild(tbody = newElement('tbody'));
  if (score !== undefined) {
    tbody.appendChild(tr = newElement('tr'));
    tr.appendChild(td = newElement('td', score, 'score'));
  }
  tally.common.characters.forEach(function (ch) {
    tbody.appendChild(tr = newElement('tr'));
    tr.appendChild(td = newElement('td', null, 'character'));
    td.appendChild(newElement('span', ch));
    tr.appendChild(newElement('td', stats.chars[ch].left, 'left'));
    tr.appendChild(newElement('td', '|', 'cursor'));
    tr.appendChild(newElement('td', stats.chars[ch].right));
  });
  [ 'common', 'distinct', 'all' ].forEach(function (name) {
    tbody.appendChild(tr = newElement('tr'));
    tr.appendChild(newElement('td', name, 'category'));
    tr.appendChild(newElement('td', stats[name].left, 'left'));
    tr.appendChild(newElement('td', '|', 'cursor'));
    tr.appendChild(newElement('td', stats[name].right));
  });
  return { stats: stats, score: score, label: label, table: table };
}

function makeReports(s, counts, low, high, baseStats) {
  var reports = [],
      tally,
      pos, ch;
  high = high || low;
  tally = {
    common: {
      total: {},
      current: {},
      sum: { total: 0, current: 0 },
      characters: []
    },
    distinct: { total: null, current: 0 },
    all: { total: s.length, current: 0 }
  };
  Object.keys(counts).forEach(function (ch) {
    var count = counts[ch];
    tally.common.total[ch] = count;
    tally.common.current[ch] = 0;
    tally.common.sum.total += count;
    tally.common.characters.push(ch);
  });
  tally.common.characters.sort(function (c, d) {
    return c.charCodeAt(0) - d.charCodeAt(0);
  });
  tally.distinct.total = tally.all.total - tally.common.sum.total;
  for (pos = 0; pos < high; ++pos) {
    if (pos >= low) {
      reports.push(makeReport(tally, s, pos, baseStats));
    }
    ch = s.charAt(pos);
    if (ch in tally.common.total) {
      ++tally.common.current[ch];
      ++tally.common.sum.current;
    } else {
      ++tally.distinct.current;
    }
    ++tally.all.current;
  }
  reports.push(makeReport(tally, s, pos, baseStats));
  return reports;
}

function splitWords(s) {
  var stripped = s.replace(/^\s+|\s+$/g, '');
  return (stripped.length == 0 ? [] : stripped.split(/\s+/));
}
function classAdd(element, name) {
  var names = splitWords(element.className),
      i;
  for (i = 0; i < names.length; ++i) {
    if (names[i] == name) {
      return;
    }
  }
  names.push(name);
  element.className = names.join(' ');
}
function classRemove(element, name) {
  var names = splitWords(element.className),
      newNames = [],
      i;
  for (i = 0; i < names.length; ++i) {
    if (names[i] !== name) {
      newNames.push(names[i]);
    }
  }
  if (newNames.length != names.length) {
    element.className = newNames.join(' ');
  }
}

function makeLabelHandler(labels, tables, pos) {
  var label = labels.children[pos],
      table = tables.children[pos];
  return function () {
    if (labels.active) {
      classRemove(labels.active, 'active');
      classRemove(tables.active, 'active');
    }
    classAdd(labels.active = label, 'active');
    classAdd(tables.active = table, 'active');
  };
}

function refresh() {
  var a = original.input.value,
      b = formatted.input.value,
      counts = getCommonCounts(a, b),
      posA = getCursorPosition(original.input),
      reports,
      originalReport;

  // Original.
  originalReport = makeReports(a, counts.a, posA)[0];
  original.labels.innerHTML = original.tables.innerHTML = '';
  original.labels.appendChild(originalReport.label);
  original.tables.appendChild(originalReport.table);
  classAdd(original.labels.children[0], 'active');
  classAdd(original.tables.children[0], 'active');

  // Formatted.
  reports = makeReports(b, counts.b, 0, b.length, originalReport.stats);
  formatted.labels.innerHTML = formatted.tables.innerHTML = '';
  reports.forEach(function (report, pos) {
    formatted.labels.appendChild(report.label);
    formatted.tables.appendChild(report.table);
    report.label.onmouseover =
        makeLabelHandler(formatted.labels, formatted.tables, pos);
  });
  reports[0].label.onmouseover();
}

window.onload = function () {
  original = document.getElementById('original');
  formatted = document.getElementById('formatted');
  original.input = original.getElementsByTagName('input')[0];
  original.labels = original.getElementsByClassName('labels')[0];
  original.tables = original.getElementsByClassName('tables')[0];
  formatted.input = formatted.getElementsByTagName('input')[0];
  formatted.labels = formatted.getElementsByClassName('labels')[0];
  formatted.tables = formatted.getElementsByClassName('tables')[0];
  [ 'change', 'keydown', 'click' ].forEach(function (eventName) {
    original.input['on' + eventName] = formatted.input['on' + eventName] = 
        function () {
          setTimeout(refresh, 0);
        };
  });
  original.input.value = '11,11';
  setCursorPosition(original.input, 4);
  original.input.focus();
  formatted.input.value = '1,111';
  refresh();
};

</script>
</head>
<body>
<div id="wrapper"> 

<div id="experiment">

  <div class="container" id="original">
    <input>
    <div class="labels"></div><div class="tables"></div>
  </div><div class="container" id="formatted">
    <input>
    <div class="labels"></div><div class="tables"></div>
  </div>

</div>

</div>
</body>
</html>
