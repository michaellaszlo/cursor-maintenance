<!DOCTYPE html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css"
 href="https://fonts.googleapis.com/css?family=Roboto">
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
body {
}
#wrapper {
}
#experiment {
  height: 100%;
  width: 800px;
  margin: 20px auto;
}
.container {
  width: 400px;
  display: inline-block;
  vertical-align: top;
  border: 1px solid #eee;
  font-family: Roboto, sans-serif;
}
input {
  width: 250px;
  text-align: center;
  font-family: Roboto, sans-serif;
  font-size: 24px;
  color: #222;
  padding: 5px 10px;
  border: 2px solid #888;
  border-radius: 5px;
  outline: none;
}
.display {
  font-size: 24px;
  color: #888;
}
.cursor {
  color: #b5471c;
  font-weight: bold;
}
</style>
<script>

// Format a non-negative integer with no zero padding.
function format(s) {
  // Delete non-digits.
  s = s.replace(/\D/g, '');
  // Delete zero padding.
  s = s.replace(/^0+/, '0');
  if (s.charAt(0) == '0' && s.length > 1) {
    s = s.substring(1);
  }
  // Insert commas to separate groups of three digits.
  s = FormatNumber.groupDigits(s);
  return s;
}

function getCursorPosition(element) {
  return element.selectionStart;
}

function setCursorPosition(element, position) {
  element.setSelectionRange(position, position);
}

var original,
    formatted;

function displayGet(display) {
  return display.innerHTML;
}
function displaySet(display, s) {
  display.innerHTML = s;
}
function displayClear(display) {
  displaySet(display, '');
}
function displayAdd(display, s) {
  displaySet(display, displayGet(display) + s);
}
function displayAddLine(display, s) {
  displayAdd(display, s + '<br>');
}
function displaySetLine(display, s) {
  displayClear(display);
  displayAddLine(display, s);
}

function getCounts(s) {
  var counts = {},
      i, ch;
  for (i = 0; i < s.length; ++i) {
    ch = s.charAt(i);
    if (ch in counts) {
      counts[ch] += 1;
    } else {
      counts[ch] = 1;
    }
  }
  return counts;
}

function getCommonCounts(a, b) {
  var aCounts = getCounts(a),
      bCounts = getCounts(b),
      counts = { a: {}, b: {} };
  Object.keys(aCounts).forEach(function (ch) {
    if (ch in bCounts) {
      counts.a[ch] = aCounts[ch];
      counts.b[ch] = bCounts[ch];
    }
  });
  return counts;
}

function refresh() {
  var a = original.input.value,
      b = formatted.input.value,
      counts = getCommonCounts(a, b),
      posA = getCursorPosition(original.input),
      pos, posB,
      tallies = {},
      tally,
      ch;

  // Tally original.
  tally = tallies.original = {
    common: {
      total: {},
      current: {},
      sum: { total: 0, current: 0 }
    },
    distinct: { total: null, current: 0 },
    all: { total: a.length, current: null }
  };
  Object.keys(counts.a).forEach(function (ch) {
    var count = counts.a[ch];
    tally.common.total[ch] = count;
    tally.common.current[ch] = 0;
    tally.common.sum.total += count;
  });
  tally.distinct.total = tally.all.total - tally.common.sum.total;
  for (pos = 0; pos < posA; ++pos) {
    ch = a.charAt(pos);
    if (ch in tally.common.total) {
      ++tally.common.current[ch];
      ++tally.common.sum.current;
    } else {
      ++tally.distinct.current;
    }
  }
  tally.all.current = posA;
  console.log(JSON.stringify(tally));

  // Tally formatted.

  // Display original.
  displaySetLine(original.display,
      a.substring(0, posA) +
      '<span class="cursor">|</span>' +
      a.substring(posA));

  // Display formatted.
  displayClear(formatted.display);
  for (pos = 0; pos <= b.length; ++pos) {
    displayAddLine(formatted.display,
        b.substring(0, pos) +
        '<span class="cursor">|</span>' +
        b.substring(pos));
  }

}

window.onload = function () {
  original = document.getElementById('original');
  formatted = document.getElementById('formatted');
  original.input = original.getElementsByTagName('input')[0];
  original.display = original.getElementsByClassName('display')[0];
  formatted.input = formatted.getElementsByTagName('input')[0];
  formatted.display = formatted.getElementsByClassName('display')[0];
  [ 'change', 'keydown', 'click' ].forEach(function (eventName) {
    original.input['on' + eventName] = formatted.input['on' + eventName] = 
        function () {
          setTimeout(refresh, 0);
        };
  });
  original.input.value = '11,11';
  setCursorPosition(original.input, 4);
  original.input.focus();
  formatted.input.value = '1,111';
  refresh();
};

</script>
</head>
<body>
<div id="wrapper"> 

<div id="experiment">

  <div class="container" id="original">
    <input>
    <div class="display"></div>
  </div><div class="container" id="formatted">
    <input>
    <div class="display"></div>
  </div>

</div>

</div>
</body>
</html>
